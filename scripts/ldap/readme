#
# Copyright (c) 2020 Seagate Technology LLC and/or its Affiliates
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#    http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.
#
# For any questions about this software or licensing,
# please email opensource@seagate.com or cortx-questions@seagate.com.
#

## Steps to update LDAP schema
NOTE - Perform these steps from the current directory
       i.e motr/fe/s3/auth-utils/ldap

1. Add/Edit attributetype and objectClass in s3user.schema. This is a user
readable file.

2. Run the following command to generate an ldif file.
```sh
    slaptest -f s3user.config -F .
```

3. Slaptest will create a directory cn=config and a file cn=config.ldif.

4. Open cn={1}s3user.ldif file generated by running slaptest.
```sh
  vi cn\=config/cn\=schema/cn\=\{1\}s3user.ldif
```

5. Copy the lines between the following lines.
Exclude the line StructuralObjectClass.

cn: {1}s3user
....
....
....
structuralObjectClass: olcSchemaConfig

6. Replace the content copied in the above step i.e from file
   cn\=config/cn\=schema/cn\=\{1\}s3user.ldif to the file cn={1}s3user.ldif in
   the current directory.

7. Delete cn=config directory
```sh
rm -rf cn\=config/
```

8. Delete cn=config.ldif file. This file is not used anywhere.
```sh
rm cn\=config.ldif
```

# Steps to configure directory replication for LDAP
# Following steps should be replicated on each primary node
# for an N-Way Multi-Main replication setup.
1. Set syncrepl as a provider
```sh
  ldapadd -Y EXTERNAL -H ldapi:/// -f syncprov_mod.ldif
```

2. Enable syncprov for directory
```sh
  ldapadd -Y EXTERNAL -H ldapi:/// -f syncprov.ldif
```

     # For an N-Way Multi-Main replication setup over SSL/TLS
     # Following steps should be replicated on each node only if SSL needs to be enabled.

     a. Check hostname if hostname is localhost change it using ```hostname -f```
     b. Goto <s3server>/scripts/ssl
     c. Create a file dns.list
        <ldap_hostname_1>
        <ldap_hostname_2>
        ...
        <ldap_hostname_n>
     d. Run following command & configure ssl certificates
        ./setup-ssl.sh --san-file dns.list
     e. Follow steps in <s3server>/scripts/ssl to create & deploy certificates.
     f. Update /etc/hosts/ for each node with ip address of rest nodes
        For example: On node1
        vim /etc/hosts/
        <ldap_hostname_2> 192.168.68.200
        ...
        <ldap_hostname_n> 192.168.68.201
     g. Enable port 636 so that openldap nodes can connect to each other
        ```sh
          firewall-cmd --zone=public --add-port=636/tcp --permanent
          firewall-cmd --reload
        ```sh


3. Setup Main node for replication
   Edit replicate.ldif to localize for current Main. Refer comments
   in replicate.ldiff for details.
```sh
  vim replicate.ldif
```
   Enable port 389 so that openldap nodes can connect to each other
```sh
firewall-cmd --zone=public --add-port=389/tcp --permanent
firewall-cmd --reload
```sh

   Add configuration to LDAP
```sh
  ldapmodify -Y EXTERNAL  -H ldapi:/// -f replicate.ldif
```

# For Configuring custom data dir for openldap we need to do following

# Perform steps to setup dir and add below to cg_ldap.ldif
# 1. It's owned by ldap (chown -R ldap:ldap /var/seagate/ldap)
# 2. Proper permissions are setup (chmod 700 /var/seagate/ldap)
# 3. Proper selinux context is setup. (chcon -R -u system_u -t slapd_db_t /var/seagate/ldap)
# 4. Verify permissions ls -ldZ /var/seagate/ldap
# drwx------. ldap ldap system_u:object_r:slapd_db_t:s0  /var/seagate/ldap
# More details https://www.systutorials.com/docs/linux/man/8-slapd_selinux/
dn: olcDatabase={2}mdb,cn=config
changetype: modify
replace: olcDbDirectory
olcDbDirectory: /var/seagate/ldap

# Useful commands
Run following command to check if ldap was setup:
```sh
ldapsearch -b "dc=s3,dc=seagate,dc=com" -x -w seagate -D "cn=admin,dc=seagate,dc=com"
```

Run following command to clean up old data
```sh
ldapdelete -x -D "cn=admin,dc=seagate,dc=com" -r "dc=seagate,dc=com" -w seagate
```
